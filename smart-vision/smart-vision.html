// === SMART VISION STREAMING ===
// 🎧 Запуск и управление микрофоном

let mediaRecorder;
let isRecording = false;
let audioChunks = [];
let accumulatedText = "";

// Элемент для вывода текста
const output = document.getElementById("output");
const micBtn = document.getElementById("micBtn");

// Плавная печать текста
function appendTextGradually(newText) {
  let i = 0;
  const speed = 25; // скорость появления символов
  const interval = setInterval(() => {
    if (i < newText.length) {
      output.textContent += newText[i];
      i++;
    } else {
      clearInterval(interval);
    }
  }, speed);
}

// === 🎙 Запуск микрофона ===
async function startMic() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    const mimeType = MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")
      ? "audio/ogg;codecs=opus"
      : "audio/webm;codecs=opus";

    mediaRecorder = new MediaRecorder(stream, { mimeType });

    console.log("🎙 Recorder format:", mimeType);

    mediaRecorder.ondataavailable = async (e) => {
      if (e.data.size > 0) {
        const blob = e.data;
        await sendAudioChunk(blob);
      }
    };

    mediaRecorder.start(2000); // каждые 2 секунды отправляем
    isRecording = true;
    micBtn.classList.add("recording");
    output.textContent = "Слушаю... 🎧";

    console.log("🎤 Recording started");
  } catch (err) {
    console.error("Ошибка доступа к микрофону:", err);
    alert("Не удалось получить доступ к микрофону");
  }
}

// === 🛑 Остановка ===
function stopMic() {
  if (mediaRecorder && isRecording) {
    mediaRecorder.stop();
    isRecording = false;
    micBtn.classList.remove("recording");
    output.textContent += "\n\n✅ Завершено.";
    console.log("🎤 Recording stopped");
  }
}

// === 📡 Отправка чанка ===
async function sendAudioChunk(blob) {
  try {
    const formData = new FormData();
    formData.append("file", blob, "audio.ogg");

    const res = await fetch("/.netlify/functions/transcribe", {
      method: "POST",
      body: formData,
    });

    if (!res.ok) {
      console.error("Transcribe error:", res.status);
      return;
    }

    const data = await res.json();
    if (data.text) {
      appendTextGradually(data.text + " ");
      accumulatedText += data.text + " ";
    }
  } catch (err) {
    console.error("Transcribe fetch error:", err);
  }
}

// === 🎛 Управление кнопкой ===
micBtn.addEventListener("click", () => {
  if (!isRecording) {
    output.textContent = "";
    startMic();
  } else {
    stopMic();
  }
});
